{% extends 'common/base.html' %}

{% block base %}
{% load static %}

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* Minimal animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    .typing-dot {
        animation: bounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
</style>

<div class="container mx-auto px-4 py-5">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-6 pb-5 border-b border-gray-200">
        <h4 class="text-2xl font-semibold text-gray-700">ğŸ’¬ AIç©ºæ°”æ™ºèŠåŠ©æ‰‹</h4>
        <p class="text-sm text-gray-500 mt-1">åŸºäºå®æ—¶æ•°æ®çš„æ™ºèƒ½ç©ºæ°”è´¨é‡å’¨è¯¢æœåŠ¡</p>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="max-w-5xl mx-auto">
                <!-- å¤©æ°”ä¿¡æ¯å¡ç‰‡ -->
        <div class="bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg p-5 text-white shadow-md hidden" id="weather-card">
            <div class="text-4xl text-center mb-3">ğŸŒ¤ï¸</div>
            <div class="text-center mb-4">
                <div class="text-xl font-semibold mb-1" id="weather-main">--</div>
                <div class="text-3xl font-bold" id="weather-temp">--â„ƒ</div>
            </div>
            <div class="flex justify-around pt-3 border-t border-white border-opacity-30">
                <div class="text-center">
                    <span class="block text-xs opacity-90 mb-1">åŸå¸‚</span>
                    <span class="block text-base font-semibold" id="weather-city">--</span>
                </div>
                <div class="text-center">
                    <span class="block text-xs opacity-90 mb-1">é£åŠ›</span>
                    <span class="block text-base font-semibold" id="weather-wind">--</span>
                </div>
                <div class="text-center">
                    <span class="block text-xs opacity-90 mb-1">æ¹¿åº¦</span>
                    <span class="block text-base font-semibold" id="weather-humidity">--%</span>
                </div>
            </div>
        </div>
        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md flex flex-col h-[600px] mb-6">
            <!-- Chat Header -->
            <div class="px-5 py-4 border-b border-gray-200 flex justify-between items-center">
                <h5 class="text-base font-semibold text-gray-700">æ™ºèƒ½å¯¹è¯</h5>
                <select class="px-3 py-1.5 border border-gray-300 rounded text-sm text-gray-700 bg-white cursor-pointer focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" id="city-select">
                    {% for city in cities %}
                    <option value="{{ city }}">{{ city }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-5 bg-gray-50" id="messages">
                <div class="flex mb-4 animate-fade-in">
                    <div class="max-w-3/4 px-4 py-3 rounded-lg bg-white border border-gray-200 text-gray-700 text-sm leading-relaxed whitespace-pre-line">
ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ç©ºæ°”è´¨é‡æ™ºèƒ½åŠ©æ‰‹ã€‚

æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
â€¢ æŸ¥è¯¢å®æ—¶ç©ºæ°”è´¨é‡æ•°æ®
â€¢ åˆ†ææ±¡æŸ“ç‰©æµ“åº¦è¶‹åŠ¿
â€¢ æä¾›æœªæ¥ç©ºæ°”è´¨é‡é¢„æµ‹
â€¢ ç»™å‡ºå¥åº·é˜²æŠ¤å»ºè®®
â€¢ å¯¹æ¯”åŸå¸‚ç©ºæ°”è´¨é‡

è¯·é€‰æ‹©åŸå¸‚å¹¶æå‡ºæ‚¨çš„é—®é¢˜ï¼
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="px-5 py-3 border-t border-gray-200 bg-white flex flex-wrap gap-2">
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="ä»Šå¤©ç©ºæ°”è´¨é‡æ€ä¹ˆæ ·ï¼Ÿ">ä»Šæ—¥ç©ºæ°”</button>
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="PM2.5æµ“åº¦æ˜¯å¤šå°‘ï¼Ÿ">PM2.5</button>
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ">å®æ—¶å¤©æ°”</button>
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="æ˜å¤©ç©ºæ°”è´¨é‡é¢„æµ‹">æ˜æ—¥é¢„æµ‹</button>
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="å¥åº·é˜²æŠ¤å»ºè®®">é˜²æŠ¤å»ºè®®</button>
                <button class="px-3 py-1.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600 cursor-pointer hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all duration-200 quick-btn" data-text="åŸå¸‚ç©ºæ°”è´¨é‡å¯¹æ¯”">åŸå¸‚å¯¹æ¯”</button>
            </div>

            <!-- Input Area -->
            <div class="px-5 py-4 border-t border-gray-200 bg-white flex gap-3">
                <input type="text" class="flex-1 px-4 py-2 border border-gray-300 rounded text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" id="message-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
                <button class="px-6 py-2 bg-blue-500 text-white rounded text-sm font-medium cursor-pointer hover:bg-blue-600 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed" id="send-btn">å‘é€</button>
            </div>
        </div>


    </div>
</div>

<script>
    let currentCity = null;

    document.addEventListener('DOMContentLoaded', () => {
        const citySelect = document.getElementById('city-select');
        if (citySelect && citySelect.value) {
            currentCity = citySelect.value;
        } else if (citySelect && citySelect.options.length > 0) {
            currentCity = citySelect.options[0].value;
        } else {
            currentCity = 'åŒ—äº¬';
        }

        citySelect.addEventListener('change', (e) => {
            currentCity = e.target.value;
            // æ›´æ–°å¤©æ°”æ˜¾ç¤ºåŸå¸‚
            document.getElementById('weather-city').textContent = currentCity;
        });

        document.querySelectorAll('.quick-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');
                document.getElementById('message-input').value = text;
                sendMessage();
            });
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const question = input.value.trim();

        if (!question) return;

        if (!currentCity) {
            addMessage('è¯·å…ˆé€‰æ‹©åŸå¸‚', 'ai');
            return;
        }

        addMessage(question, 'user');
        input.value = '';

        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;
        addTypingIndicator();

        try {
            const response = await fetch('/myApp/ai_chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    question: question,
                    city: currentCity
                })
            });

            removeTypingIndicator();

            if (response.ok) {
                const data = await response.json();
                addMessage(data.reply, 'ai');

                if (data.weather) {
                    updateDataPanel(data);
                }
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                addMessage('æŠ±æ­‰ï¼ŒæœåŠ¡å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            removeTypingIndicator();
            addMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'ai');
        } finally {
            sendBtn.disabled = false;
        }
    }

    function addMessage(text, type) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'user'
            ? 'flex justify-end mb-4 animate-fade-in'
            : 'flex mb-4 animate-fade-in';

        const bubbleClass = type === 'user'
            ? 'max-w-3/4 px-4 py-3 rounded-lg bg-blue-500 text-white text-sm leading-relaxed whitespace-pre-line'
            : 'max-w-3/4 px-4 py-3 rounded-lg bg-white border border-gray-200 text-gray-700 text-sm leading-relaxed whitespace-pre-line';

        messageDiv.innerHTML = `<div class="${bubbleClass}">${escapeHtml(text)}</div>`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addTypingIndicator() {
        const messagesDiv = document.getElementById('messages');
        const indicator = document.createElement('div');
        indicator.className = 'flex mb-4';
        indicator.id = 'typing-indicator';
        indicator.innerHTML = '<div class="px-4 py-3 rounded-lg bg-white border border-gray-200 w-fit flex gap-1"><span class="h-2 w-2 bg-blue-500 rounded-full typing-dot"></span><span class="h-2 w-2 bg-blue-500 rounded-full typing-dot"></span><span class="h-2 w-2 bg-blue-500 rounded-full typing-dot"></span></div>';
        messagesDiv.appendChild(indicator);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function updateDataPanel(data) {
        // æ›´æ–°å¤©æ°”ä¿¡æ¯
        if (data.weather) {
            const weatherCard = document.getElementById('weather-card');
            weatherCard.classList.remove('hidden');

            document.getElementById('weather-city').textContent = data.city || currentCity;
            document.getElementById('weather-main').textContent = data.weather.weather;
            document.getElementById('weather-temp').textContent = data.weather.temperature + 'â„ƒ';
            document.getElementById('weather-wind').textContent = data.weather.winddirection + 'é£ ' + data.weather.windpower + 'çº§';
            document.getElementById('weather-humidity').textContent = data.weather.humidity + '%';
        }
    }

    function getCookie(name) {
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken && name === 'csrftoken') {
            return metaToken.getAttribute('content');
        }

        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || metaToken?.getAttribute('content');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

{% endblock %}
