{% extends 'common/base.html' %}

{% block base %}
{% load static %}

<style>
    /* é‡ç½®ä¸€äº›base.htmlçš„æ ·å¼ */
    .page-content {
        padding: 20px !important;
    }

    /* AIèŠå¤©å®¹å™¨ */
    .ai-container {
        max-width: 100%;
        margin: 0 auto;
    }

    /* é¡µé¢æ ‡é¢˜ */
    .page-title-box {
        padding-bottom: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid #eff2f7;
    }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #495057;
        margin: 0;
    }

    .page-title-desc {
        color: #74788d;
        font-size: 14px;
        margin-top: 5px;
    }

    /* ä¸»å¸ƒå±€ */
    .ai-main-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 24px;
    }

    /* èŠå¤©å¡ç‰‡ */
    .chat-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    .chat-header {
        padding: 20px;
        border-bottom: 1px solid #eff2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-title {
        font-size: 16px;
        font-weight: 600;
        color: #495057;
        margin: 0;
    }

    .city-select {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
        background: #fff;
        cursor: pointer;
    }

    .city-select:focus {
        border-color: #556ee6;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(85,110,230,.25);
    }

    /* æ¶ˆæ¯åŒºåŸŸ */
    .messages-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        justify-content: flex-end;
    }

    .message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 8px;
        word-wrap: break-word;
        white-space: pre-line;
        font-size: 14px;
        line-height: 1.6;
    }

    .message.ai .message-bubble {
        background: #fff;
        border: 1px solid #e3e6ef;
        color: #495057;
    }

    .message.user .message-bubble {
        background: #556ee6;
        color: #fff;
    }

    /* å¿«æ·æ“ä½œ */
    .quick-actions {
        padding: 12px 20px;
        border-top: 1px solid #eff2f7;
        background: #fff;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .quick-btn {
        padding: 6px 12px;
        background: #f8f9fa;
        border: 1px solid #e3e6ef;
        border-radius: 4px;
        font-size: 13px;
        color: #74788d;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-btn:hover {
        background: #556ee6;
        color: #fff;
        border-color: #556ee6;
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-wrapper {
        padding: 20px;
        border-top: 1px solid #eff2f7;
        background: #fff;
        display: flex;
        gap: 12px;
    }

    .message-input {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
    }

    .message-input:focus {
        border-color: #556ee6;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(85,110,230,.25);
    }

    .send-btn {
        padding: 10px 24px;
        background: #556ee6;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .send-btn:hover:not(:disabled) {
        background: #4a5fc1;
    }

    .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* æ•°æ®é¢æ¿ */
    .data-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        padding: 24px;
        height: calc(100vh - 200px);
        min-height: 600px;
        overflow-y: auto;
    }

    .data-title {
        font-size: 16px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
    }

    /* AQIæ˜¾ç¤ºå¡ç‰‡ */
    .aqi-card {
        text-align: center;
        padding: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        color: #fff;
        margin-bottom: 16px;
    }

    .aqi-value {
        font-size: 48px;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .aqi-label {
        font-size: 18px;
        font-weight: 500;
        opacity: 0.95;
    }

    .aqi-time {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 8px;
    }

    /* å¤©æ°”å¡ç‰‡ */
    .weather-card {
        background: linear-gradient(135deg, #56CCF2 0%, #2F80ED 100%);
        border-radius: 8px;
        padding: 20px;
        color: #fff;
        margin-bottom: 16px;
    }

    .weather-icon {
        font-size: 40px;
        text-align: center;
        margin-bottom: 12px;
    }

    .weather-info {
        text-align: center;
        margin-bottom: 16px;
    }

    .weather-main {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .weather-temp {
        font-size: 32px;
        font-weight: bold;
    }

    .weather-details {
        display: flex;
        justify-content: space-around;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.3);
    }

    .weather-item {
        text-align: center;
    }

    .weather-label {
        display: block;
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
    }

    .weather-value {
        display: block;
        font-size: 16px;
        font-weight: 600;
    }

    /* æŒ‡æ ‡ç½‘æ ¼ */
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .metric-item {
        padding: 16px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #556ee6;
    }

    .metric-label {
        font-size: 12px;
        color: #74788d;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: #495057;
    }

    .metric-unit {
        font-size: 12px;
        color: #adb5bd;
        margin-left: 2px;
    }

    /* è¶‹åŠ¿å›¾ */
    .trend-section {
        margin-top: 24px;
    }

    .trend-title {
        font-size: 14px;
        font-weight: 600;
        color: #74788d;
        margin-bottom: 12px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: #fff;
        border: 1px solid #e3e6ef;
        border-radius: 8px;
        width: fit-content;
    }

    .typing-indicator.active {
        display: block;
    }

    .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #556ee6;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
        animation: bounce 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    /* å“åº”å¼ */
    @media (max-width: 1200px) {
        .ai-main-layout {
            grid-template-columns: 1fr;
        }
        .data-card {
            height: auto;
            min-height: 400px;
        }
    }
</style>

<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-title-box">
        <h4 class="page-title">ğŸ’¬ AIç©ºæ°”æ™ºèŠåŠ©æ‰‹</h4>
        <p class="page-title-desc">åŸºäºå®æ—¶æ•°æ®çš„æ™ºèƒ½ç©ºæ°”è´¨é‡å’¨è¯¢æœåŠ¡</p>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="ai-main-layout">
        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-card">
            <div class="chat-header">
                <h5 class="chat-title">æ™ºèƒ½å¯¹è¯</h5>
                <select class="city-select" id="city-select">
                    {% for city in cities %}
                    <option value="{{ city }}">{{ city }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="messages-wrapper" id="messages">
                <div class="message ai">
                    <div class="message-bubble">
ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ç©ºæ°”è´¨é‡æ™ºèƒ½åŠ©æ‰‹ã€‚

æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
â€¢ æŸ¥è¯¢å®æ—¶ç©ºæ°”è´¨é‡æ•°æ®
â€¢ åˆ†ææ±¡æŸ“ç‰©æµ“åº¦è¶‹åŠ¿
â€¢ æä¾›æœªæ¥ç©ºæ°”è´¨é‡é¢„æµ‹
â€¢ ç»™å‡ºå¥åº·é˜²æŠ¤å»ºè®®
â€¢ å¯¹æ¯”åŸå¸‚ç©ºæ°”è´¨é‡

è¯·é€‰æ‹©åŸå¸‚å¹¶æå‡ºæ‚¨çš„é—®é¢˜ï¼
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="quick-btn" data-text="ä»Šå¤©ç©ºæ°”è´¨é‡æ€ä¹ˆæ ·ï¼Ÿ">ä»Šæ—¥ç©ºæ°”</button>
                <button class="quick-btn" data-text="PM2.5æµ“åº¦æ˜¯å¤šå°‘ï¼Ÿ">PM2.5</button>
                <button class="quick-btn" data-text="ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ">å®æ—¶å¤©æ°”</button>
                <button class="quick-btn" data-text="æ˜å¤©ç©ºæ°”è´¨é‡é¢„æµ‹">æ˜æ—¥é¢„æµ‹</button>
                <button class="quick-btn" data-text="å¥åº·é˜²æŠ¤å»ºè®®">é˜²æŠ¤å»ºè®®</button>
                <button class="quick-btn" data-text="åŸå¸‚ç©ºæ°”è´¨é‡å¯¹æ¯”">åŸå¸‚å¯¹æ¯”</button>
            </div>

            <div class="input-wrapper">
                <input type="text" class="message-input" id="message-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
                <button class="send-btn" id="send-btn">å‘é€</button>
            </div>
        </div>

        <!-- æ•°æ®é¢æ¿ -->
        <div class="data-card">
            <h5 class="data-title">ğŸ“Š å®æ—¶æ•°æ®ç›‘æ§</h5>

            <div class="aqi-card">
                {% if latest_aqi %}
                <div class="aqi-value" id="aqi-value">{{ latest_aqi.aqi|floatformat:0 }}</div>
                <div class="aqi-label" id="aqi-label">{{ latest_aqi.city }}</div>
                <div class="aqi-time">{{ latest_aqi.updatetime|date:"Y-m-d H:i" }} æ›´æ–°</div>
                {% else %}
                <div class="aqi-value">--</div>
                <div class="aqi-label">æš‚æ— æ•°æ®</div>
                {% endif %}
            </div>

            <!-- å¤©æ°”ä¿¡æ¯å¡ç‰‡ -->
            <div class="weather-card" id="weather-card" style="display: none;">
                <div class="weather-icon">ğŸŒ¤ï¸</div>
                <div class="weather-info">
                    <div class="weather-main" id="weather-main">--</div>
                    <div class="weather-temp" id="weather-temp">--â„ƒ</div>
                </div>
                <div class="weather-details">
                    <div class="weather-item">
                        <span class="weather-label">é£åŠ›</span>
                        <span class="weather-value" id="weather-wind">--</span>
                    </div>
                    <div class="weather-item">
                        <span class="weather-label">æ¹¿åº¦</span>
                        <span class="weather-value" id="weather-humidity">--%</span>
                    </div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-label">PM2.5</div>
                    <div class="metric-value" id="metric-pm25">--<span class="metric-unit">Î¼g/mÂ³</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">PM10</div>
                    <div class="metric-value" id="metric-pm10">--<span class="metric-unit">Î¼g/mÂ³</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Oâ‚ƒ</div>
                    <div class="metric-value" id="metric-o3">--<span class="metric-unit">Î¼g/mÂ³</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">CO</div>
                    <div class="metric-value" id="metric-co">--<span class="metric-unit">mg/mÂ³</span></div>
                </div>
            </div>

            <div class="trend-section">
                <div class="trend-title">è¿‘7æ—¥AQIè¶‹åŠ¿</div>
                <canvas id="trend-chart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentCity = null;
    let trendChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        const citySelect = document.getElementById('city-select');
        if (citySelect && citySelect.value) {
            currentCity = citySelect.value;
        } else if (citySelect && citySelect.options.length > 0) {
            currentCity = citySelect.options[0].value;
        } else {
            currentCity = 'åŒ—äº¬';
        }

        initTrendChart();

        citySelect.addEventListener('change', (e) => {
            currentCity = e.target.value;
            loadTrendData(currentCity);
        });

        document.querySelectorAll('.quick-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');
                document.getElementById('message-input').value = text;
                sendMessage();
            });
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const question = input.value.trim();

        if (!question) return;

        if (!currentCity) {
            addMessage('è¯·å…ˆé€‰æ‹©åŸå¸‚', 'ai');
            return;
        }

        addMessage(question, 'user');
        input.value = '';

        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;
        addTypingIndicator();

        try {
            const response = await fetch('/myApp/ai_chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    question: question,
                    city: currentCity
                })
            });

            removeTypingIndicator();

            if (response.ok) {
                const data = await response.json();
                addMessage(data.reply, 'ai');

                if (data.current_aqi) {
                    updateDataPanel(data);
                }
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                addMessage('æŠ±æ­‰ï¼ŒæœåŠ¡å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            removeTypingIndicator();
            addMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'ai');
        } finally {
            sendBtn.disabled = false;
        }
    }

    function addMessage(text, type) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `<div class="message-bubble">${escapeHtml(text)}</div>`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addTypingIndicator() {
        const messagesDiv = document.getElementById('messages');
        const indicator = document.createElement('div');
        indicator.className = 'message ai';
        indicator.innerHTML = '<div class="typing-indicator active"><span></span><span></span><span></span></div>';
        indicator.id = 'typing-indicator';
        messagesDiv.appendChild(indicator);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function updateDataPanel(data) {
        // æ›´æ–°AQI
        if (data.current_aqi) {
            document.getElementById('aqi-value').textContent = Math.round(data.current_aqi);
        }

        // æ›´æ–°å¤©æ°”ä¿¡æ¯
        if (data.weather) {
            const weatherCard = document.getElementById('weather-card');
            weatherCard.style.display = 'block';

            document.getElementById('weather-main').textContent = data.weather.weather;
            document.getElementById('weather-temp').textContent = data.weather.temperature + 'â„ƒ';
            document.getElementById('weather-wind').textContent = data.weather.winddirection + 'é£ ' + data.weather.windpower + 'çº§';
            document.getElementById('weather-humidity').textContent = data.weather.humidity + '%';
        }
    }

    function initTrendChart() {
        const ctx = document.getElementById('trend-chart').getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'AQI',
                    data: [],
                    borderColor: '#556ee6',
                    backgroundColor: 'rgba(85, 110, 230, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#556ee6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // åŠ è½½åˆå§‹æ•°æ®
        if (currentCity) {
            loadTrendData(currentCity);
        }
    }

    async function loadTrendData(city) {
        try {
            const response = await fetch(`/myApp/get_trend_data/?city=${encodeURIComponent(city)}`);
            if (response.ok) {
                const data = await response.json();
                if (trendChart) {
                    trendChart.data.labels = data.labels;
                    trendChart.data.datasets[0].data = data.values;
                    trendChart.update();
                }
            }
        } catch (error) {
            console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
        }
    }

    function getCookie(name) {
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken && name === 'csrftoken') {
            return metaToken.getAttribute('content');
        }

        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || metaToken?.getAttribute('content');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

{% endblock %}
